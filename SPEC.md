Perfect — below is your **fully updated unified SPEC.md (v0.3)** including:

* ✅ Persistence-first architecture
* ✅ PDF export
* ✅ Night mode (Dark theme)
* ✅ Explicit tests mapped to every acceptance criterion

This is now production-grade spec clarity.

---

# BookWise — Product & Technical Spec (v0.3)

---

# 1) Overview

BookWise is a clean, modern web application that helps users deeply understand books through structured AI-assisted insights.

Users can:

* Search English-only books via Open Library
* Click into a structured learning page
* Use a “Surprise Me” button
* Generate structured AI sections
* Download a PDF of summaries
* Toggle between Light and Night Mode

---

# 2) Core Design Principles

1. **Persistence-first architecture**
2. **Strict frontend/backend separation**
3. **No API key exposure**
4. **Schema-validated LLM outputs**
5. **Clean, minimal UI**
6. **Full acceptance-criteria test coverage**

---

# 3) User Experience

---

## 3.1 Landing Page (`/`)

### Layout

1. Rotating quote banner (random per load; duplicates allowed)
2. Instant English-only search
3. Scrollable result container
4. “Surprise Me” button
5. Theme toggle (Light / Night mode)

---

## 3.2 Night Mode (New Requirement)

### Functional Requirements

* Toggle button in top-right header
* Default behavior:

  * System preference detection (`prefers-color-scheme`)
* User override persists in:

  * localStorage
* No backend involvement required

### Design Rules

* Night mode must:

  * Maintain contrast accessibility (WCAG AA)
  * Use dark neutral background (not pure black)
  * Maintain readable typography
  * Adjust shadows to subtle glow instead of drop shadow
  * Ensure code blocks / quizzes remain readable

### Implementation Notes

* Tailwind dark mode class strategy
* Use CSS variables for:

  * background
  * surface
  * border
  * text-primary
  * text-secondary
* All components must support both themes

---

## 3.3 Book Detail Page (`/book/:workId`)

Sections:

1. Cover + Summary + Author Info
2. Key ideas
3. Chapter summary
4. Critique
5. Quiz
6. PDF Download Button

Each section:

* Loads independently
* Shows skeleton state
* Displays “Stored” vs “Generated” indicator

---

# 4) Functional Requirements

---

## 4.1 Search

```http
GET /api/search?q=...&limit=...
```

* English-only filtering
* Debounced frontend
* Scrollable results container
* Backend proxied

---

## 4.2 Curated “Surprise Me”

* `data/curated_books.yml`
* Returns canonical Open Library Work ID

---

## 4.3 Persistence-First Generation

Before any LLM call:

1. Query database
2. If exists → return stored
3. If not → generate → validate → persist → return

No duplicate LLM calls allowed.

---

# 5) Persistence Layer

---

## Database

Default: SQLite
Future: Postgres compatible

---

## Tables

### `books`

* id
* title
* authors
* first_publish_year
* cover_url
* openlibrary_url
* timestamps

---

### `book_generations`

* id
* book_id
* section
* content_json
* provider
* model
* prompt_version
* schema_version
* timestamps

---

### Unique Constraint

(book_id, section, model, prompt_version, schema_version)

---

# 6) PDF Export

---

## Endpoint

```http
GET /api/books/{id}/export/pdf
```

---

## Behavior

* Ensure:

  * overview
  * key_ideas
  * critique exist
* Generate missing sections if needed
* Render server-side
* Return binary PDF

---

## Filename Format

```
{Title} - {Author} - {Year}.pdf
```

Sanitized + length capped.

---

## PDF Content

* Title page
* Summary
* Key Ideas
* Critique
* Footer: Generated by BookWise

---

# 7) API Design

Search
Curated Random
Book Metadata
Generate Section
Quiz
Export PDF

(All persistence-first)

---

# 8) LLM Config

`backend/config/llm.yml`

```yaml
provider: openai
model: gpt-5.2
temperature: 0.4
max_output_tokens: 1200
timeout_seconds: 45
```

Secrets via environment variables only.

---

# 9) Frontend Architecture

---

Stack:

* React + TypeScript
* TailwindCSS (dark mode class strategy)
* shadcn/ui
* React Router
* React Query

---

## Components

* QuoteBanner
* SearchBar
* SearchResultsList
* SurpriseMeButton
* ThemeToggle
* BookHeader
* SectionCard
* QuizCard
* PDFDownloadButton

---

# 10) Backend Architecture

---

Stack:

* FastAPI
* SQLModel / SQLAlchemy
* Pydantic
* httpx
* Structured logging

---

Modules:

* openlibrary client
* LLM provider abstraction
* generation service
* persistence service
* pdf service
* security middleware

---

# 11) Security Requirements

---

## API Keys

* Backend only
* Never exposed
* Never logged

---

## Input Validation

* Query length validation
* Filename sanitization
* Schema validation on all LLM outputs

---

## Rate Limiting

Per-IP for:

* Search
* Generation
* PDF Export

---

## Prompt Injection Mitigation

* Treat Open Library metadata as untrusted
* Explicit prompt boundaries
* Instruct model to ignore embedded malicious instructions

---

# 12) Acceptance Criteria

The following must be true before release:

1. Landing page rotates quotes.
2. Search is instant, English-only, scrollable.
3. Surprise Me returns valid curated book.
4. Book detail page loads all sections.
5. Persistence prevents duplicate LLM calls.
6. PDF export works and filename format is correct.
7. No API keys visible in frontend or responses.
8. Night mode toggles correctly and persists preference.
9. All sections clearly show stored vs generated state.
10. System handles invalid input gracefully.
11. All endpoints enforce validation.
12. Prompt injection attempts do not alter output structure.

---

# 13) Test Plan (New Section)

All acceptance criteria must have explicit test coverage.

---

## 13.1 Frontend Tests

Using:

* Jest
* React Testing Library
* Playwright (E2E)

### Test Cases

✅ Quote rotates between reloads
✅ Search debounce works
✅ Only English books returned
✅ Results container scrolls properly
✅ Clicking result navigates correctly
✅ Surprise Me works
✅ Night mode toggles and persists
✅ PDF download triggers correct endpoint
✅ Stored badge appears when section is persisted

---

## 13.2 Backend Unit Tests

Using:

* Pytest

### Persistence

✅ Insert and retrieve generation
✅ Unique constraint prevents duplicates
✅ Retrieval logic returns stored before LLM call
✅ Force regeneration works

---

### LLM Layer

✅ Schema validation rejects malformed output
✅ Prompt version stored correctly
✅ No secret in logs

---

### PDF Service

✅ Filename sanitization
✅ Correct sections included
✅ Proper content disposition header
✅ PDF binary returned

---

### Security

✅ CORS correctly restricted
✅ Rate limit triggers properly
✅ Query validation rejects short/long inputs
✅ Prompt injection test case ignored

---

## 13.3 Integration Tests

Using mocked Open Library + mocked LLM:

✅ Full flow: search → book → generate → stored → export PDF
✅ Repeat generation does not call LLM
✅ Export triggers generation if missing

---

## 13.4 End-to-End Tests

Using Playwright:

✅ User search → view book → generate → download PDF
✅ Reload → data loads instantly (from persistence)
✅ Toggle night mode → reload → preference persists

---

# 14) Repo Structure

```
bookwise/
  SPEC.md
  data/
    curated_books.yml
    quotes.yml

  frontend/
    src/
      components/
      pages/
      api/
      theme/

  backend/
    config/
    prompts/
    app/
      api/
      services/
      clients/
      llm/
      schemas/
      db/
      middleware/
      tests/
```

---